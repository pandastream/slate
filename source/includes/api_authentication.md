## API Authentication

For examples of authentication implementation please refer to the [Ruby gem](https://github.com/pandastream/panda_gem) and example [PHP client](https://github.com/pandastream/panda_client_php).

The Panda API requires all requests must also be signed to ensure they are valid and authenticated. For GET and DELETE requests the additional parameters must be url encoded and added to the parameters in the url. When making a POST or PUT request they should be included in the usual parameters payload submitted.

The `access_key` and `secret_key` used to authenticate the request are provided when you sign up for your Panda account. Your keys can always be found by logging in to your account by visiting [pandastream.com](https://www.pandastream.com)

A correctly signed request contains the following additional parameters:

parameters | atributes
------------ | -------------
access_key | Provided when you sign up for Panda
cloud_id   | Provided when you sign up for Panda
timestamp  | Current UTC time in iso8601 format
signature  | HMAC signature generated as described below

### Build the signature

The `signature` is generated using the following method:

1. Create a `canonical_querystring` by url encoding all of the parameters and the values, and joining them into one stringusing the `=` character to separate keys and their values, and the `&` character to separate the key value pairs.

    All parameters and values have to be joined in the alphabetical order.

    Make sure it encodes the given string according to Â» RFC 3986. (spaces are escaped using `%20` and not a `+`)

    A typical `canonical_querystring` might look as follows: `access_key=85f8dbe6-b998-11de-82e1-001ec2b5c0e1&cloud_id=bd54547d152e91104d82c0a81e7d5ff2&timestamp=2009-10-15T15%3A38%3A42%2B01%3A00` ... other parameters such as those in the POST request would also be added to this string.

2. Construct the `string_to_sign` by concatenating the uppercase HTTP request method (GET, POST, PUT or DELETE), hostname (api.pandastream.com or api-eu.pandastream.com), request uri (e.g. /videos.json) and `canonical_querystring` with newlines (\\n).

    The api version `/v2` should not be part of the request uri

3. To generate the `signature`, first **HMAC SHA256** encode the complete `string_to_sign` using your `secret_key` as the key. For example, using Ruby: `hmac = HMAC::SHA256.new(secret_key)` then `hmac.update(string_to_sign)`

4. Then take the **binary digest** of the hmac output and **base 64** encode it. Make sure to remove any newline characters at the end. In Ruby you would do `Base64.encode64(hmac.digest).chomp`

5. The signature could be rejected by the server for the following reasons:
    the request is a POST request and the signature has already been used
    the request is POST /videos.json and the timestamp is expired for 30 minutes
    the request is not POST and the timestamp is expired for 5 minutes

### Worked example

```
cloud_id = '123456789'
access_key = 'abcdefgh'
secret_key = 'ijklmnop'
```

Assume that we wish to get all videos we have uploaded to our cloud (US account)

<div style="clear: both;"></div>

```
api.pandastream.com/v2/videos.json
```

We first construct the request uri.

<div style="clear: both;"></div>

```
access_key  abcdefgh
cloud_id    123456789
timestamp   2011-03-01T15:39:10.260762Z
```

We send the following query parameters.

<div style="clear: both;"></div>

```
GET\napi.pandastream.com\n/videos.json\naccess_key=abcdefgh&cloud_id=123456789&timestamp=2011-03-01T15%3A39%3A10.260762Z
```

The signature is generated by signing the following string.

<div style="clear: both;"></div>

```
kVnZs%2FNX13ldKPdhFYoVnoclr8075DwiZF0TGgIbMsc%3D
```

This should be signed by generating the HMAC SHA256 hex digest with secret key `ijklmnop`.

<div style="clear: both;"></div>

```
GET /videos.json
QUERY
access_key=abcdefgh&cloud_id=123456789&timestamp=2011-03-01T15%3A39%3A10.260762Z&signature=kVnZs%2FNX13ldKPdhFYoVnoclr8075DwiZF0TGgIbMsc%3D
```

The api request then becomes

<div style="clear: both;"></div>

```
$ curl http://api.pandastream.com/v2/videos.json?access_key=abcdefgh&cloud_id=123456789&timestamp=2011-03-01T15:39:10.260762Z&signature=kVnZs%2FNX13ldKPdhFYoVnoclr8075DwiZF0TGgIbMsc%3D
status: "200"
body: "[]"
```

Here is the request and response made with curl

<div style="clear: both;"></div>

### Things to look into if you're having signature issues

* Ensure that the timestamp is uppercase and strict iso8601 format.
* Check the url in the `string_to_sign` does **not** include `/v2`, even though `/v2` is required as part of the actual url you will request when accessing the api.
* Only url-encode the parameter values of the `canonical_querystring` and not the whole `string_to_sign`.
* The signature should end in an `=` sign and not contain any more characters afterwards. For example, if your HMAC library is adding the characters `3D` after the `=` you must remove these.
* Make sure you use the **binary digest** of the HMAC and not any other outputs such as the hex digest.
* Make sure that URL encoded characters are uppercase (%3A and not %3a).
* Make sure inside the string_to_sign you use `GET` for GET request, `POST` for POST request, etc...

<div style="clear: both;"></div>

